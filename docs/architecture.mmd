---
title: EY Data Platform Architecture
---

graph TD
    %% Data Sources
    subgraph APIS["External APIs"]
        direction LR
        A1[Products API<br/>fakestoreapi.com/products]
        A2[Users API<br/>fakestoreapi.com/users]
        A3[Carts API<br/>fakestoreapi.com/carts]
    end

    %% Ingestion Layer
    subgraph INGESTION["Ingestion Pipelines"]
        direction LR
        B1[Batch Ingester<br/>Daily Schedule<br/>batch_ingest.py]
        B2[Cart Poller<br/>60s intervals<br/>carts_poller.py]
        B3[Stream Consumer<br/>Real-time<br/>carts_consumer.py]
    end

    %% Message Broker
    C1[Pub/Sub Topic<br/>carts-events]
    C2[Subscription<br/>carts-events-sub]

    %% Raw Storage
    subgraph STORAGE["Raw Data Layer"]
        D1[Cloud Storage<br/>JSONL Files<br/>Date Partitioned]
        D2[BigQuery Raw<br/>bq_raw dataset]
    end

    %% Transformation Layer
    subgraph TRANSFORM["dbt Transformations"]
        E1[Staging Layer<br/>stg_products<br/>stg_users<br/>stg_cart_events]
        E2[Marts Layer<br/>dim_products<br/>dim_users<br/>fact_orders]
    end

    %% Analytics Layer
    F1[Star Schema<br/>bq_analytics dataset<br/>BI Ready]

    %% Infrastructure
    subgraph INFRA["Infrastructure"]
        G1[Service Account<br/>BigQuery + GCS + Pub/Sub]
        G2[Python Environment<br/>dbt + GCP SDKs]
        G3[Configuration<br/>.env + profiles.yml]
    end

    %% Data Flow - Batch
    A1 -->|HTTP GET| B1
    A2 -->|HTTP GET| B1
    B1 -->|JSONL| D1
    D1 -->|Load Job| D2

    %% Data Flow - Streaming
    A3 -->|HTTP Poll| B2
    B2 -->|Publish| C1
    C1 --> C2
    C2 -->|Subscribe| B3
    B3 -->|JSONL| D1
    B3 -->|Stream Insert| D2

    %% Data Flow - Transformations
    D2 -->|Source| E1
    E1 -->|dbt ref| E2
    E2 -->|Analytics| F1

    %% Styling
    classDef apiStyle fill:#e3f2fd,stroke:#1976d2,stroke-width:3px,color:#000
    classDef ingestStyle fill:#f3e5f5,stroke:#7b1fa2,stroke-width:3px,color:#000
    classDef streamStyle fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000
    classDef storageStyle fill:#e8f5e8,stroke:#388e3c,stroke-width:3px,color:#000
    classDef transformStyle fill:#fce4ec,stroke:#c2185b,stroke-width:3px,color:#000
    classDef analyticsStyle fill:#e1f5fe,stroke:#0277bd,stroke-width:2px,color:#000
    classDef infraStyle fill:#f1f8e9,stroke:#558b2f,stroke-width:3px,color:#000

    classDef componentStyle fill:#ffffff,stroke:#666666,stroke-width:2px,color:#000

    class APIS apiStyle
    class INGESTION ingestStyle
    class C1,C2 streamStyle
    class STORAGE storageStyle
    class TRANSFORM transformStyle
    class F1 analyticsStyle
    class INFRA infraStyle

    class A1,A2,A3 componentStyle
    class B1,B2,B3 componentStyle
    class D1,D2 componentStyle
    class E1,E2 componentStyle
    class G1,G2,G3 componentStyle